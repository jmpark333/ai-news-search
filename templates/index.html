<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>최신 AI 기사 검색기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f39c12;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .nav-tabs {
            border-bottom: 2px solid var(--light-color);
            margin-bottom: 2rem;
        }

        .nav-tabs .nav-link {
            border: none;
            color: var(--dark-color);
            font-weight: 600;
            padding: 1rem 1.5rem;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            background: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .nav-tabs .nav-link:hover {
            background: var(--light-color);
            border-radius: 10px 10px 0 0;
        }

        .content-section {
            padding: 2rem;
        }

        .search-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .search-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .result-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .result-card:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--primary-color);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #3a7bc8;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(74, 144, 226, 0.3);
        }

        .btn-success {
            background: var(--success-color);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }

        .form-control,
        .form-select {
            border-radius: 10px;
            border: 2px solid var(--light-color);
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid var(--light-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .relevance-score {
            background: linear-gradient(135deg, #f39c12, #e74c3c);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .source-badge {
            background: var(--dark-color);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .date-badge {
            background: var(--light-color);
            color: var(--dark-color);
            padding: 0.15rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .excluded-item {
            background: #f8f9fa;
            border-left: 4px solid var(--danger-color);
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0 10px 10px 0;
        }

        .stats-card {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stats-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .alert-custom {
            border-radius: 10px;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .pagination {
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .pagination .page-link {
            border-radius: 10px;
            margin: 0;
            border: none;
            color: var(--primary-color);
            min-width: 40px;
            text-align: center;
            padding: 0.5rem;
        }

        .pagination .page-item {
            margin: 0 0.125rem;
        }

        .pagination .page-item.active .page-link {
            background: var(--primary-color);
            color: white;
        }

        .pagination .page-item.disabled .page-link {
            color: #6c757d;
            cursor: not-allowed;
        }

        .pagination .page-ellipsis {
            padding: 0.5rem;
            color: #6c757d;
            user-select: none;
        }

        .blog-content {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 2rem;
            margin-top: 1rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .blog-content h1,
        .blog-content h2,
        .blog-content h3 {
            color: var(--dark-color);
            margin-bottom: 1rem;
        }

        .blog-content p {
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .blog-content pre {
            background: var(--dark-color);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            overflow-x: auto;
        }

        .blog-content code {
            background: var(--light-color);
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .excluded-item .d-flex>div:first-child {
            word-break: break-all;
            flex-grow: 1;
        }

        .excluded-item .d-flex>div:last-child {
            flex-shrink: 0;
        }

        .filtered-section {
            display: none;
            margin-top: 1.5rem;
            border-top: 1px solid #dee2e6;
            padding-top: 1.5rem;
        }

        .filtered-card {
            opacity: 0.8;
            background-color: #f8f9fa;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> 최신 AI 기사 검색기</h1>
            <p>최신 AI 기술 동향을 검색하고 관리합니다</p>
        </div>

        <div class="container-fluid">
            <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search"
                        type="button" role="tab">
                        <i class="fas fa-search"></i> 기사 검색
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="database-tab" data-bs-toggle="tab" data-bs-target="#database"
                        type="button" role="tab">
                        <i class="fas fa-database"></i> 데이터베이스
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="exclude-tab" data-bs-toggle="tab" data-bs-target="#exclude"
                        type="button" role="tab">
                        <i class="fas fa-ban"></i> 제외 관리
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="mainTabContent">
                <!-- 기사 검색 탭 -->
                <div class="tab-pane fade show active" id="search" role="tabpanel">
                    <div class="content-section">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="search-card card">
                                    <div class="card-body">
                                        <h5 class="card-title"><i class="fas fa-newspaper"></i> 최신 AI 기사 검색</h5>
                                        <p class="card-text">최근 7일 이내의 AI 관련 최신 기사를 검색합니다.</p>
                                        <button class="btn btn-primary w-100" onclick="searchLatestArticles()">
                                            <i class="fas fa-search"></i> 최신 기사 검색
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="search-card card">
                                    <div class="card-body">
                                        <h5 class="card-title"><i class="fas fa-keyboard"></i> 사용자 지정 검색</h5>
                                        <div class="mb-3">
                                            <input type="text" class="form-control" id="customTopic"
                                                placeholder="검색할 주제를 입력하세요">
                                        </div>
                                        <button class="btn btn-success w-100" onclick="searchCustomTopic()">
                                            <i class="fas fa-search"></i> 주제 검색
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="loading" id="searchLoading">
                            <div class="spinner"></div>
                            <p>검색 중입니다...</p>
                        </div>

                        <div id="searchResults" class="mt-4"></div>
                    </div>
                </div>

                <!-- 데이터베이스 탭 -->
                <div class="tab-pane fade" id="database" role="tabpanel">
                    <div class="content-section">
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-number" id="totalArticles">0</div>
                                    <div class="stats-label">전체 기사 수</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card" onclick="filterDatabaseArticlesBySource('Naver')"
                                    style="cursor: pointer;">
                                    <div class="stats-number" id="naverArticles">0</div>
                                    <div class="stats-label">네이버 기사</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card" onclick="filterDatabaseArticlesBySource('DuckDuckGo')"
                                    style="cursor: pointer;">
                                    <div class="stats-number" id="ddgArticles">0</div>
                                    <div class="stats-label">DuckDuckGo 기사</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stats-card">
                                    <div class="stats-number" id="excludedCount">0</div>
                                    <div class="stats-label">제외된 항목</div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h5 class="card-title"><i class="fas fa-database"></i> 데이터베이스 기사 목록</h5>
                                        <div id="filterStatus" class="mt-2" style="display: none;">
                                            <span class="badge bg-info text-white">
                                                <i class="fas fa-filter"></i>
                                                <span id="currentFilterText">전체</span> 기사만 표시 중
                                            </span>
                                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearSourceFilter()">
                                                <i class="fas fa-times"></i> 필터 해제
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <div class="input-group" style="max-width: 500px; float: right;">
                                            <input type="text" class="form-control" id="databaseSearchInput"
                                                placeholder="제목으로 검색..." onkeypress="handleSearchKeyPress(event)">
                                            <button class="btn btn-outline-secondary" type="button"
                                                onclick="searchDatabaseArticles()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                            <button class="btn btn-primary" type="button"
                                                onclick="loadDatabaseArticles()">
                                                <i class="fas fa-refresh"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="loading" id="databaseLoading">
                                    <div class="spinner"></div>
                                    <p>데이터를 로딩 중입니다...</p>
                                </div>

                                <div id="databaseArticles"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 제외 관리 탭 -->
                <div class="tab-pane fade" id="exclude" role="tabpanel">
                    <div class="content-section">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title"><i class="fas fa-globe"></i> 제외된 사이트 관리</h5>
                                        <div class="mb-3">
                                            <input type="text" class="form-control" id="excludeDomain"
                                                placeholder="제외할 도메인을 입력하세요">
                                        </div>
                                        <div class="mb-3">
                                            <input type="text" class="form-control" id="excludeReason"
                                                placeholder="제외 사유 (선택사항)">
                                        </div>
                                        <button class="btn btn-danger" onclick="addExcludedSite()">
                                            <i class="fas fa-plus"></i> 사이트 추가
                                        </button>
                                        <button class="btn btn-primary ms-2" onclick="loadExcludedSites()">
                                            <i class="fas fa-refresh"></i> 새로고침
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title"><i class="fas fa-link"></i> 제외된 페이지 관리</h5>
                                        <div class="mb-3">
                                            <input type="text" class="form-control" id="excludeUrl"
                                                placeholder="제외할 URL을 입력하세요">
                                        </div>
                                        <div class="mb-3">
                                            <input type="text" class="form-control" id="excludeTitle"
                                                placeholder="페이지 제목 (선택사항)">
                                        </div>
                                        <div class="mb-3">
                                            <input type="text" class="form-control" id="excludePageReason"
                                                placeholder="제외 사유 (선택사항)">
                                        </div>
                                        <button class="btn btn-danger" onclick="addExcludedPage()">
                                            <i class="fas fa-plus"></i> 페이지 추가
                                        </button>
                                        <button class="btn btn-primary ms-2" onclick="loadExcludedPages()">
                                            <i class="fas fa-refresh"></i> 새로고침
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h6><i class="fas fa-globe"></i> 제외된 사이트 목록</h6>
                                <div id="excludedSitesList"></div>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-link"></i> 제외된 페이지 목록</h6>
                                <div id="excludedPagesList"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 전역 변수
        let databasePage = 1;
        const itemsPerPage = 10;
        let currentSourceFilter = ''; // 현재 선택된 소스 필터를 추적하는 전역 변수 추가

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function () {
            loadDatabaseArticles();
            loadExcludedSites();
            loadExcludedPages();

            // 데이터베이스 탭 활성화 시 통계 로드
            var databaseTabButton = document.getElementById('database-tab');
            if (databaseTabButton) {
                databaseTabButton.addEventListener('shown.bs.tab', function (event) {
                    loadDatabaseStats();
                });
            }
        });

        // 최신 AI 기사 검색
        async function searchLatestArticles() {
            console.log('최신 AI 기사 검색 시작...');
            showLoading('searchLoading');
            hideElement('searchResults');

            try {
                console.log('API 요청 전송...');
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('API 응답 수신:', response);
                const data = await response.json();
                console.log('파싱된 데이터:', data);
                hideLoading('searchLoading');

                if (data.success) {
                    console.log('검색 성공, 결과 수:', data.results.length);
                    displaySearchResults(data); // 전체 데이터 객체 전달
                } else {
                    console.error('검색 실패:', data.error);
                    showAlert('검색 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('검색 오류 발생:', error);
                hideLoading('searchLoading');
                showAlert('검색 오류: ' + error.message, 'danger');
            }
        }

        // 사용자 지정 주제 검색
        async function searchCustomTopic() {
            const topic = document.getElementById('customTopic').value.trim();
            if (!topic) {
                showAlert('검색할 주제를 입력하세요.', 'warning');
                return;
            }

            showLoading('searchLoading');
            hideElement('searchResults');

            try {
                const response = await fetch('/api/custom-search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ topic: topic })
                });

                const data = await response.json();
                hideLoading('searchLoading');

                if (data.success) {
                    displaySearchResults(data); // 전체 데이터 객체 전달
                } else {
                    showAlert('검색 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                hideLoading('searchLoading');
                showAlert('검색 오류: ' + error.message, 'danger');
            }
        }

        // 날짜 문자열을 Date 객체로 변환하는 함수
        function parseDate(dateString) {
            if (!dateString) return new Date(0); // 날짜가 없으면 가장 오래된 날짜로 설정
            
            // 다양한 날짜 형식 처리
            const formats = [
                // YYYY-MM-DD 형식
                /(\d{4})-(\d{1,2})-(\d{1,2})/,
                // YYYY/MM/DD 형식
                /(\d{4})\/(\d{1,2})\/(\d{1,2})/,
                // MM/DD 형식 (연도 없음)
                /(\d{1,2})\/(\d{1,2})/,
                // "X일 전" 형식
                /(\d+)일 전/,
                // "X시간 전" 형식
                /(\d+)시간 전/
            ];

            for (let format of formats) {
                const match = dateString.match(format);
                if (match) {
                    if (format === formats[0] || format === formats[1]) {
                        // YYYY-MM-DD 또는 YYYY/MM/DD
                        const year = parseInt(match[1]);
                        const month = parseInt(match[2]) - 1; // JavaScript 월은 0부터 시작
                        const day = parseInt(match[3]);
                        return new Date(year, month, day);
                    } else if (format === formats[2]) {
                        // MM/DD (현재 연도 가정)
                        const month = parseInt(match[1]) - 1;
                        const day = parseInt(match[2]);
                        const currentYear = new Date().getFullYear();
                        return new Date(currentYear, month, day);
                    } else if (format === formats[3]) {
                        // "X일 전"
                        const daysAgo = parseInt(match[1]);
                        return new Date(Date.now() - daysAgo * 24 * 60 * 60 * 1000);
                    } else if (format === formats[4]) {
                        // "X시간 전"
                        const hoursAgo = parseInt(match[1]);
                        return new Date(Date.now() - hoursAgo * 60 * 60 * 1000);
                    }
                }
            }

            // 파싱 실패 시 현재 날짜에서 하루 전으로 설정
            return new Date(Date.now() - 24 * 60 * 60 * 1000);
        }

        // 검색 결과 표시 (필터링된 기사 포함)
        function displaySearchResults(data) {
            let results = data.results || [];
            const filtered = data.filtered || [];

            console.log('검색 결과 표시 함수 호출, 결과 수:', results.length, '필터링 수:', filtered.length);
            const container = document.getElementById('searchResults');

            if (!container) return;

            if (results.length === 0 && filtered.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info alert-custom">
                        <i class="fas fa-info-circle"></i> 검색 결과가 없습니다.
                    </div>
                `;
                return;
            }

            // 결과를 날짜 기준으로 내림차순 정렬 (최신 기사가 맨 위로)
            results.sort((a, b) => {
                const dateA = parseDate(a.publish_date);
                const dateB = parseDate(b.publish_date);
                return dateB.getTime() - dateA.getTime(); // 내림차순 (최신이 먼저)
            });

            console.log('정렬된 검색 결과:', results.map(r => ({
                title: r.title,
                date: r.publish_date,
                parsed: parseDate(r.publish_date).toISOString()
            })));

            let html = `
                <div class="alert alert-success alert-custom d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-check-circle"></i> ${results.length}개의 검색 결과를 찾았습니다.</span>
                    ${filtered.length > 0 ? `
                        <button class="btn btn-sm btn-outline-danger" type="button" onclick="toggleFilteredSection()">
                            <i class="fas fa-filter"></i> 필터링된 기사 ${filtered.length}개 보기
                        </button>
                    ` : ''}
                </div>
            `;

            // 필터링된 기사 섹션 (숨김 상태로 시작)
            if (filtered.length > 0) {
                // 필터링된 기사도 날짜 기준으로 내림차순 정렬 (최신 기사가 맨 위로)
                filtered.sort((a, b) => {
                    const dateA = parseDate(a.publish_date);
                    const dateB = parseDate(b.publish_date);
                    return dateB.getTime() - dateA.getTime(); // 내림차순 (최신이 먼저)
                });

                html += `<div id="filteredResultsSection" class="filtered-section mb-4">
                    <h6 class="text-danger"><i class="fas fa-filter"></i> 필터링된 기사 목록 (자동 제외됨)</h6>
                `;

                filtered.forEach(item => {
                    const safeTitle = escapeHtml(item.title || '제목 없음');
                    const safeUrl = escapeHtml(item.url || '#');
                    const reason = escapeHtml(item.filter_reason || '알 수 없음');

                    html += `
                        <div class="result-card card filtered-card mb-2">
                            <div class="card-body py-2">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h6 class="card-title mb-1" style="font-size: 0.95rem;">
                                            <a href="${safeUrl}" target="_blank" class="text-decoration-none text-secondary">${safeTitle}</a>
                                        </h6>
                                        <small class="text-danger"><i class="fas fa-ban"></i> ${reason}</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <button class="btn btn-sm btn-success" onclick="restoreArticle(${item.id}, '${encodeURIComponent(item.title || '제목 없음').replace(/'/g, "%27")}')">
                                            <i class="fas fa-database"></i> 저장
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            // 정상 검색 결과
            results.forEach(result => {
                const safeTitle = escapeHtml(result.title);
                const safeUrl = escapeHtml(result.url);
                const score = Number(result.relevance_score || 0);

                html += `
                    <div class="result-card card">
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-md-7">
                                    <h6 class="card-title">
                                        <a href="${safeUrl}" target="_blank" class="text-decoration-none text-primary">${safeTitle}</a>
                                    </h6>
                                </div>
                                <div class="col-md-5 text-end">
                                    <span class="source-badge">${escapeHtml(result.source)}</span>
                                    <span class="date-badge ms-1">${escapeHtml(result.publish_date)}</span>
                                    <span class="relevance-score ms-1">점수: ${(score * 100).toFixed(1)}</span>
                                </div>
                            </div>
                            <p class="card-text">${escapeHtml(result.summary)}</p>
                            <div class="row">
                                <div class="col-md-8">
                                    <small class="text-muted"><a href="${safeUrl}" target="_blank" class="text-decoration-none text-muted">${safeUrl.substring(0, 60)}...</a></small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-sm btn-warning" onclick="excludePageFromArticle('${encodeURIComponent(result.url).replace(/'/g, "%27")}', '${encodeURIComponent(result.title).replace(/'/g, "%27")}', this)">
                                        <i class="fas fa-ban"></i> 제외
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteArticleByUrl('${encodeURIComponent(result.url).replace(/'/g, "%27")}', '${encodeURIComponent(result.title).replace(/'/g, "%27")}')">
                                        <i class="fas fa-trash"></i> 삭제
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            container.style.display = 'block';
        }

        function toggleFilteredSection() {
            const section = document.getElementById('filteredResultsSection');
            if (section) {
                if (section.style.display === 'none' || section.style.display === '') {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            }
        }

        // 기사 복구 (DB 저장)
        async function restoreArticle(articleId, encodedTitle) {
            const title = decodeURIComponent(encodedTitle);
            if (!confirm(`"${title}" 기사를 데이터베이스에 저장하시겠습니까?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/restore-article/${articleId}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('기사가 저장되었습니다.', 'success');
                    // 해당 카드를 찾아서 제거하거나 UI 업데이트 (간단히 새로고침 권장하지 않음, UI만 제거)
                    // 여기서는 간단히 알림만 표시
                } else {
                    showAlert('저장 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('오류 발생: ' + error.message, 'danger');
            }
        }

        // URL로 기사 삭제 (검색 결과용)
        async function deleteArticleByUrl(encodedUrl, encodedTitle) {
            const url = decodeURIComponent(encodedUrl);
            const title = decodeURIComponent(encodedTitle);

            if (!confirm(`"${title}" 기사를 삭제하시겠습니까? (제외 목록에 추가됨)`)) {
                return;
            }
            // 실제로는 excludePageFromArticle과 동일하게 동작하여 다시 검색되지 않도록 함
            // 사용자 경험상 "삭제"는 목록에서 사라지는 것이므로 제외 처리가 적절함
            // 인코딩된 상태 그대로 전달 (excludePageFromArticle 내부에서 디코딩함)
            excludePageFromArticle(encodedUrl, encodedTitle);
        }

        // 데이터베이스 통계 로드
        async function loadDatabaseStats() {
            try {
                const response = await fetch('/api/database-articles?page=1&perPage=1000');
                const data = await response.json();
                console.log('전체 통계 로드 데이터:', data);

                if (data.success && data.articles) {
                    document.getElementById('totalArticles').textContent = data.totalCount || 0;

                    // 전체 데이터에 대한 소스별 통계 계산
                    let naverCount = 0;
                    let ddgCount = 0;

                    data.articles.forEach(article => {
                        if (article.source === 'Naver') {
                            naverCount++;
                        } else if (article.source === 'DuckDuckGo') {
                            ddgCount++;
                        }
                    });

                    document.getElementById('naverArticles').textContent = naverCount;
                    document.getElementById('ddgArticles').textContent = ddgCount;

                    console.log('전체 통계 업데이트:', {
                        naverCount: naverCount,
                        ddgCount: ddgCount,
                        totalArticles: data.totalCount
                    });
                }
            } catch (error) {
                console.error('통계 로드 오류:', error);
            }
        }

        // 데이터베이스 기사 로드
        async function loadDatabaseArticles(page = 1, source = null) {
            console.log(`loadDatabaseArticles 호출됨, 페이지: ${page}, 소스: ${source}`);
            showLoading('databaseLoading');

            const container = document.getElementById('databaseArticles');
            if (container) {
                container.style.display = 'none';
            }

            try {
                let apiUrl = `/api/database-articles?page=${page}&perPage=${itemsPerPage}`;
                if (source) {
                    apiUrl += `&source=${encodeURIComponent(source)}`;
                    currentSourceFilter = source; // 현재 소스 필터를 전역 변수에 저장
                } else {
                    currentSourceFilter = ''; // 소스가 없으면 필터 초기화
                }
                
                // 필터 상태 표시 업데이트
                updateFilterStatus();
                console.log(`API 요청: ${apiUrl}`);
                const response = await fetch(apiUrl);
                console.log('API 응답 수신:', response.status);
                const data = await response.json();
                console.log('파싱된 데이터:', data);
                hideLoading('databaseLoading');

                if (data.success) {
                    console.log('데이터베이스 로드 성공, displayDatabaseArticles 호출');
                    displayDatabaseArticles(data);
                    // loadDatabaseStats(); // 기사 로드 후 전체 통계를 다시 불러올 필요는 없음 (탭 활성화 시 이미 호출됨)
                } else {
                    console.error('데이터베이스 로드 실패:', data.error);
                    showAlert('데이터베이스 로드 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                hideLoading('databaseLoading');
                showAlert('데이터베이스 로드 오류: ' + error.message, 'danger');
            }
        }

        // 데이터베이스 기사 검색
        async function searchDatabaseArticles(page = 1, source = null) {
            const searchQuery = document.getElementById('databaseSearchInput').value.trim();

            console.log(`searchDatabaseArticles 호출됨, 검색어: ${searchQuery}, 페이지: ${page}, 소스: ${source}`);
            showLoading('databaseLoading');

            const container = document.getElementById('databaseArticles');
            if (container) {
                container.style.display = 'none';
            }

            try {
                let apiUrl = `/api/database-articles?page=${page}&perPage=${itemsPerPage}`;
                if (searchQuery) {
                    apiUrl += `&search=${encodeURIComponent(searchQuery)}`;
                }
                // source 파라미터가 없으면 현재 필터를 사용, 있으면 새로운 필터를 사용
                const sourceToUse = source || currentSourceFilter;
                if (sourceToUse) {
                    apiUrl += `&source=${encodeURIComponent(sourceToUse)}`;
                    // 새로운 소스가 제공되면 현재 필터를 업데이트
                    if (source) {
                        currentSourceFilter = source;
                    }
                } else {
                    currentSourceFilter = ''; // 소스가 없으면 필터 초기화
                }
                
                // 필터 상태 표시 업데이트
                updateFilterStatus();

                console.log(`검색 API 요청: ${apiUrl}`);
                const response = await fetch(apiUrl);
                console.log('검색 API 응답 수신:', response.status);
                const data = await response.json();
                console.log('검색 파싱된 데이터:', data);
                hideLoading('databaseLoading');

                if (data.success) {
                    console.log('데이터베이스 검색 성공, displayDatabaseArticles 호출');
                    displayDatabaseArticles(data);
                    // updateDatabaseStats(data); // 검색 시에는 전체 통계를 업데이트하지 않음
                } else {
                    console.error('데이터베이스 검색 실패:', data.error);
                    showAlert('데이터베이스 검색 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                hideLoading('databaseLoading');
                showAlert('데이터베이스 검색 오류: ' + error.message, 'danger');
            }
        }

        // 특정 소스로 데이터베이스 기사 필터링
        function filterDatabaseArticlesBySource(source) {
            // 검색 입력 필드 초기화 (필요시)
            document.getElementById('databaseSearchInput').value = '';
            loadDatabaseArticles(1, source);
        }

        // 검색 입력창에서 Enter 키 처리
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                searchDatabaseArticles(1);
            }
        }

        // 데이터베이스 기사 표시
        function displayDatabaseArticles(data) {
            console.log('displayDatabaseArticles 함수 호출됨, 데이터:', data);
            const container = document.getElementById('databaseArticles');

            // 데이터 유효성 검사 강화
            if (!data || !data.articles || !Array.isArray(data.articles)) {
                console.error('유효하지 않은 데이터 구조:', data);
                container.innerHTML = `
                    <div class="alert alert-warning alert-custom">
                        <i class="fas fa-exclamation-triangle"></i> 데이터 형식이 올바르지 않습니다.
                    </div>
                `;
                return;
            }

            if (data.articles.length === 0) {
                console.log('데이터베이스에 기사가 없습니다.');
                container.innerHTML = `
                    <div class="alert alert-info alert-custom">
                        <i class="fas fa-info-circle"></i> 데이터베이스에 기사가 없습니다.
                    </div>
                `;
                return;
            }

            // 데이터베이스 기사도 날짜 기준으로 내림차순 정렬 (최신 기사가 맨 위로)
            data.articles.sort((a, b) => {
                const dateA = parseDate(a.publish_date);
                const dateB = parseDate(b.publish_date);
                return dateB.getTime() - dateA.getTime(); // 내림차순 (최신이 먼저)
            });

            let html = '';

            console.log('기사 배열 처리 시작, 기사 수:', data.articles.length);
            data.articles.forEach((article, index) => {
                console.log(`기사 ${index + 1} 처리:`, article);
                console.log(`기사 ${index + 1} 타입:`, typeof article);
                console.log(`기사 ${index + 1} 키:`, Object.keys(article));

                // 기사 데이터 유효성 검사
                if (!article || typeof article !== 'object') {
                    console.error(`유효하지 않은 기사 데이터: ${article}`);
                    return; // continue 대신 return 사용 (forEach에서)
                }

                // 안전한 문자열 처리 - 각 속성에 직접 접근
                const title = article.title || '제목 없음';
                const source = article.source || '알 수 없음';
                const date = article.publish_date || '알 수 없음';
                const summary = article.summary || '요약 없음';
                const url = article.url || 'URL 없음';

                console.log(`기사 ${index + 1} 속성 추출:`, {
                    title: title,
                    source: source,
                    date: date,
                    summary: summary,
                    url: url
                });

                const safeTitle = String(title).replace(/'/g, "\\'").replace(/"/g, '\\"');
                const safeSource = String(source);
                const safeDate = String(date);
                const safeSummary = String(summary);
                const safeUrl = String(url);

                html += `
                    <div class="result-card card">
                        <div class="card-body">
                            <div class="row mb-2">
                                <div class="col-md-7">
                                    <h6 class="card-title">
                                        <a href="${safeUrl}" target="_blank" rel="noopener noreferrer" class="text-decoration-none text-primary">
                                            ${escapeHtml(safeTitle)}
                                        </a>
                                    </h6>
                                </div>
                                <div class="col-md-5 text-end">
                                    <span class="source-badge">${escapeHtml(safeSource)}</span>
                                    <span class="date-badge ms-1">${escapeHtml(safeDate)}</span>
                                </div>
                            </div>
                            <p class="card-text">${escapeHtml(safeSummary)}</p>
                            <div class="row">
                                <div class="col-md-8">
                                    <small class="text-muted">${escapeHtml(safeUrl)}</small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-primary" onclick="generateBlogFromResult('${encodeURIComponent(title).replace(/'/g, "%27")}')" title="블로그 생성">
                                            <i class="fas fa-magic"></i>
                                        </button>
                                        <button class="btn btn-sm btn-warning" onclick="excludePageFromArticle('${encodeURIComponent(url).replace(/'/g, "%27")}', '${encodeURIComponent(title).replace(/'/g, "%27")}', this)" title="페이지 제외">
                                            <i class="fas fa-unlink"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteArticle('${encodeURIComponent(url).replace(/'/g, "%27")}', '${encodeURIComponent(title).replace(/'/g, "%27")}')" title="삭제">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            // 페이지네이션
            if (data.totalPages > 1) {
                html += generatePagination(data.currentPage, data.totalPages);
            }

            console.log('HTML 생성 완료, 컨테이너에 설정...');
            container.innerHTML = html;
            console.log('데이터베이스 기사 표시 완료');
            console.log('설정된 HTML 길이:', html.length);
            console.log('컨테이너 innerHTML 설정 후:', container.innerHTML.length);

            // 강제로 리플로우 트리거
            container.style.display = 'none';
            container.style.display = 'block';

            // 결과가 표시되는지 최종 확인
            setTimeout(() => {
                const cards = container.querySelectorAll('.result-card');
                console.log('표시된 데이터베이스 기사 카드 수:', cards.length);
                console.log('실제 표시된 HTML:', container.innerHTML.substring(0, 500) + '...');

                if (cards.length === 0) {
                    console.warn('데이터베이스 기사 카드가 표시되지 않음');
                    // 디버깅을 위해 직접 HTML 설정
                    container.innerHTML = `
                        <div class="alert alert-warning alert-custom">
                            <i class="fas fa-exclamation-triangle"></i> 디버그: ${data.articles.length}개의 기사 데이터는 있지만 표시되지 않습니다.
                            <br><small>HTML 길이: ${html.length}</small>
                        </div>
                    `;
                } else {
                    console.log('데이터베이스 기사 카드가 정상적으로 표시됨');
                }
            }, 100);
        }

        // 데이터베이스 통계 업데이트
        function updateDatabaseStats(data) {
            document.getElementById('totalArticles').textContent = data.totalCount || 0;

            // 소스별 통계 계산
            let naverCount = 0;
            let ddgCount = 0;

            if (data.articles && Array.isArray(data.articles)) {
                data.articles.forEach(article => {
                    if (article.source === 'Naver') {
                        naverCount++;
                    } else if (article.source === 'DuckDuckGo') {
                        ddgCount++;
                    }
                    // 디버깅을 위한 로그 추가
                    console.log('기사 소스:', article.source, '제목:', article.title);
                });
            }

            document.getElementById('naverArticles').textContent = naverCount;
            document.getElementById('ddgArticles').textContent = ddgCount;

            // 디버깅을 위한 로그 추가
            console.log('통계 업데이트:', {
                naverCount: naverCount,
                ddgCount: ddgCount,
                totalArticles: data.articles ? data.articles.length : 0
            });
        }

        // 페이지네이션 생성
        function generatePagination(currentPage, totalPages) {
            let html = '<nav><ul class="pagination">';

            // 이전 페이지
            if (currentPage > 1) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="searchDatabaseArticles(${currentPage - 1}, '${currentSourceFilter}'); return false;">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>`;
            }

            // 첫 페이지 (현재 페이지가 1보다 클 때만 표시)
            if (currentPage > 3) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="searchDatabaseArticles(1, '${currentSourceFilter}'); return false;">1</a>
                </li>`;

                if (currentPage > 4) {
                    html += `<li class="page-item page-ellipsis">...</li>`;
                }
            }

            // 현재 페이지 주변 페이지 표시 (최대 5개)
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    html += `<li class="page-item active">
                        <a class="page-link" href="#">${i}</a>
                    </li>`;
                } else {
                    html += `<li class="page-item">
                        <a class="page-link" href="#" onclick="searchDatabaseArticles(${i}, '${currentSourceFilter}'); return false;">${i}</a>
                    </li>`;
                }
            }

            // 마지막 페이지 (현재 페이지가 마지막-2보다 작을 때만 표시)
            if (currentPage < totalPages - 2) {
                if (currentPage < totalPages - 3) {
                    html += `<li class="page-item page-ellipsis">...</li>`;
                }
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="searchDatabaseArticles(${totalPages}, '${currentSourceFilter}'); return false;">${totalPages}</a>
                </li>`;
            }

            // 다음 페이지
            if (currentPage < totalPages) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="searchDatabaseArticles(${currentPage + 1}, '${currentSourceFilter}'); return false;">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>`;
            }

            html += '</ul></nav>';
            return html;
        }

        // 제외된 사이트 로드
        async function loadExcludedSites() {
            try {
                const response = await fetch('/api/excluded-sites');
                const data = await response.json();

                if (data.success) {
                    displayExcludedSites(data.sites);
                    updateExcludedCount(data.sites.length);
                }
            } catch (error) {
                console.error('제외된 사이트 로드 오류:', error);
            }
        }

        // 제외된 페이지 로드
        async function loadExcludedPages() {
            try {
                const response = await fetch('/api/excluded-pages');
                const data = await response.json();

                if (data.success) {
                    displayExcludedPages(data.pages);
                }
            } catch (error) {
                console.error('제외된 페이지 로드 오류:', error);
            }
        }

        // 제외된 사이트 표시
        function displayExcludedSites(sites) {
            const container = document.getElementById('excludedSitesList');

            if (sites.length === 0) {
                container.innerHTML = '<p class="text-muted">제외된 사이트가 없습니다.</p>';
                return;
            }

            let html = '';
            sites.forEach(site => {
                html += `
                    <div class="excluded-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${escapeHtml(site.domain)}</strong>
                                ${site.url_pattern ? `<br><small class="text-muted">${escapeHtml(site.url_pattern)}</small>` : ''}
                                <br><small class="text-muted">${site.reason} - ${site.created_at}</small>
                            </div>
                            <div>
                                ${site.active ?
                        `<button class="btn btn-sm btn-danger" onclick="removeExcludedSite(${site.id}, '${escapeHtml(site.domain)}')" title="삭제">
                                        <i class="fas fa-trash"></i>
                                    </button>` :
                        '<span class="badge bg-secondary">비활성</span>'
                    }
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // 제외된 페이지 표시
        function displayExcludedPages(pages) {
            const container = document.getElementById('excludedPagesList');

            if (pages.length === 0) {
                container.innerHTML = '<p class="text-muted">제외된 페이지가 없습니다.</p>';
                return;
            }

            let html = '';
            pages.forEach(page => {
                html += `
                    <div class="excluded-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${escapeHtml(page.title || '제목 없음')}</strong>
                                <br><small class="text-muted">${escapeHtml(page.url)}</small>
                                <br><small class="text-muted">${page.reason} - ${page.created_at}</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-danger" onclick="removeExcludedPage(${page.id}, '${escapeHtml(page.url)}', '${escapeHtml(page.title || '제목 없음')}')" title="삭제">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // 제외된 사이트 추가
        async function addExcludedSite() {
            const domain = document.getElementById('excludeDomain').value.trim();
            const reason = document.getElementById('excludeReason').value.trim() || 'user_excluded';

            if (!domain) {
                showAlert('제외할 도메인을 입력하세요.', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/excluded-sites', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ domain, reason })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(data.message, 'success');
                    document.getElementById('excludeDomain').value = '';
                    document.getElementById('excludeReason').value = '';
                    loadExcludedSites();
                } else {
                    showAlert('제외된 사이트 추가 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('제외된 사이트 추가 오류: ' + error.message, 'danger');
            }
        }

        // 제외된 페이지 추가
        async function addExcludedPage() {
            const url = document.getElementById('excludeUrl').value.trim();
            const title = document.getElementById('excludeTitle').value.trim();
            const reason = document.getElementById('excludePageReason').value.trim() || 'user_excluded';

            if (!url) {
                showAlert('제외할 URL을 입력하세요.', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/excluded-pages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url, title, reason })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(data.message, 'success');
                    document.getElementById('excludeUrl').value = '';
                    document.getElementById('excludeTitle').value = '';
                    document.getElementById('excludePageReason').value = '';
                    loadExcludedPages();
                } else {
                    showAlert('제외된 페이지 추가 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('제외된 페이지 추가 오류: ' + error.message, 'danger');
            }
        }

        // 제외된 사이트 삭제
        async function removeExcludedSite(siteId, domain) {
            if (!confirm(`"${domain}" 도메인을 제외 목록에서 완전 삭제하시겠습니까? 삭제된 사이트는 다시 검색결과에 포함될 수 있습니다.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/excluded-sites/${siteId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(data.message, 'success');
                    loadExcludedSites();
                } else {
                    showAlert('제외된 사이트 제거 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('제외된 사이트 제거 오류: ' + error.message, 'danger');
            }
        }

        // 제외된 페이지 삭제
        async function removeExcludedPage(pageId, url) {
            if (!confirm(`"${url}" 페이지를 제외 목록에서 완전 삭제하시겠습니까? 삭제된 페이지는 다시 검색결과에 포함될 수 있습니다.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/excluded-pages/${pageId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(data.message, 'success');
                    loadExcludedPages();
                } else {
                    showAlert('제외된 페이지 제거 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('제외된 페이지 제거 오류: ' + error.message, 'danger');
            }
        }

        // 제외된 항목 수 업데이트
        function updateExcludedCount(count) {
            document.getElementById('excludedCount').textContent = count;
        }

        // 기사 삭제
        async function deleteArticle(encodedUrl, encodedTitle) {
            const url = decodeURIComponent(encodedUrl);
            const title = decodeURIComponent(encodedTitle);

            if (!confirm(`"${title}" 기사를 데이터베이스에서 삭제하시겠습니까?`)) {
                return;
            }

            try {
                // 기사 ID를 찾기 위해 데이터베이스 기사 목록에서 검색
                const articlesResponse = await fetch('/api/database-articles?page=1&perPage=1000');
                const articlesData = await articlesResponse.json();

                let articleId = null;
                if (articlesData.success && articlesData.articles) {
                    const article = articlesData.articles.find(a => a.url === url);
                    if (article && article.id) {
                        articleId = article.id;
                    }
                }

                if (!articleId) {
                    showAlert('기사를 찾을 수 없습니다.', 'warning');
                    return;
                }

                const response = await fetch(`/api/delete-article/${articleId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(data.message, 'success');
                    // 데이터베이스 목록 새로고침
                    loadDatabaseArticles(databasePage);
                    loadDatabaseStats();
                } else {
                    showAlert('기사 삭제 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('기사 삭제 오류: ' + error.message, 'danger');
            }
        }

        // 기사에서 사이트 제외 (기존 기능 유지)
        async function excludeSiteFromArticle(url, title) {
            // URL에서 도메인 추출
            try {
                const urlObj = new URL(url);
                const domain = urlObj.hostname;

                if (!confirm(`"${domain}" 도메인을 제외 목록에 추가하시겠습니까? 이 도메인의 모든 기사가 향후 검색에서 제외됩니다.`)) {
                    return;
                }

                const response = await fetch('/api/excluded-sites', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        domain: domain,
                        reason: `기사 "${title}"에서 제외됨`
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(data.message, 'success');
                    // 제외된 사이트 목록 새로고침
                    loadExcludedSites();
                    // 데이터베이스 기사 목록도 새로고침
                    loadDatabaseArticles(databasePage);
                    loadDatabaseStats();
                } else {
                    showAlert('사이트 제외 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('사이트 제외 오류: ' + error.message, 'danger');
            }
        }

        // 기사에서 페이지 제외 (새로운 기능)
        async function excludePageFromArticle(encodedUrl, encodedTitle, btnElement = null) {
            const url = decodeURIComponent(encodedUrl);
            const title = decodeURIComponent(encodedTitle);

            if (!confirm(`"${title}" 페이지를 제외 목록에 추가하시겠습니까? 이 페이지는 향후 검색에서 제외됩니다.`)) {
                return;
            }

            try {
                const response = await fetch('/api/excluded-pages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        title: title,
                        reason: `기사 "${title}"에서 제외됨`
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(data.message, 'success');

                    // 버튼 UI 업데이트
                    if (btnElement) {
                        btnElement.innerHTML = '<i class="fas fa-check"></i> 제외됨';
                        btnElement.classList.remove('btn-warning');
                        btnElement.classList.add('btn-secondary');
                        btnElement.disabled = true;
                    }

                    // 제외된 페이지 목록 새로고침
                    loadExcludedPages();
                    // 데이터베이스 기사 목록도 새로고침 (현재 탭이 데이터베이스가 아닐 경우를 위해)
                    if (document.getElementById('database-tab').classList.contains('active')) {
                        loadDatabaseArticles(databasePage);
                        loadDatabaseStats();
                    }
                } else {
                    showAlert('페이지 제외 실패: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('페이지 제외 오류: ' + error.message, 'danger');
            }
        }

        // 블로그 통계 업데이트
        function updateBlogStats(length) {
            const generatedElement = document.getElementById('generatedCount');
            const totalWordsElement = document.getElementById('totalWords');

            const currentGenerated = parseInt(generatedElement.textContent) || 0;
            const currentTotalWords = parseInt(totalWordsElement.textContent) || 0;

            generatedElement.textContent = currentGenerated + 1;
            totalWordsElement.textContent = currentTotalWords + length;
        }

        // 유틸리티 함수
        function showLoading(elementId) {
            document.getElementById(elementId).classList.add('show');
        }

        function hideLoading(elementId) {
            document.getElementById(elementId).classList.remove('show');
        }

        function showElement(elementId) {
            document.getElementById(elementId).style.display = 'block';
        }

        function hideElement(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }

        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show alert-custom" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            // 알림을 페이지 상단에 표시
            const alertContainer = document.createElement('div');
            alertContainer.innerHTML = alertHtml;
            alertContainer.style.position = 'fixed';
            alertContainer.style.top = '20px';
            alertContainer.style.right = '20px';
            alertContainer.style.zIndex = '9999';
            alertContainer.style.maxWidth = '400px';

            document.body.appendChild(alertContainer);

            // 5초 후 자동 제거
            setTimeout(() => {
                if (alertContainer.parentNode) {
                    alertContainer.parentNode.removeChild(alertContainer);
                }
            }, 5000);
        }

        // 필터 상태 표시 업데이트
        function updateFilterStatus() {
            const filterStatus = document.getElementById('filterStatus');
            const filterText = document.getElementById('currentFilterText');
            
            if (currentSourceFilter) {
                if (filterStatus) {
                    filterStatus.style.display = 'block';
                }
                if (filterText) {
                    filterText.textContent = currentSourceFilter;
                }
            } else {
                if (filterStatus) {
                    filterStatus.style.display = 'none';
                }
            }
        }
        
        // 소스 필터 해제
        function clearSourceFilter() {
            currentSourceFilter = '';
            loadDatabaseArticles(1);
            updateFilterStatus();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;',
                '`': '&#96;',
                '/': '&#x2F;'
            };
            return String(text).replace(/[&<>"'`/]/g, m => map[m]);
        }
    </script>
</body>

</html>